<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Flight Map + Info Pane</title>
  <script type="importmap">
  {
    "imports": {
      "gleo/": "https://unpkg.com/gleo/src/"
    }
  }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="antialiased">
  <div class="grid grid-cols-4 h-screen">
    <div id="gleomap" class="col-span-3"></div>
    <aside id="infoPane" class="col-span-1 bg-gray-800 text-white p-4 overflow-y-auto"></aside>
  </div>

  <script type="module">
    import MercatorMap   from "gleo/MercatorMap.mjs";
    import MercatorTiles from "gleo/loaders/MercatorTiles.mjs";
    import Chain         from "gleo/symbols/Chain.mjs";
    import Circle        from "gleo/symbols/Circle.mjs";
    import TextLabel     from "gleo/symbols/TextLabel.mjs";

    const infoPane = document.getElementById("infoPane");
    const params = new URLSearchParams(window.location.search);
    const flightId = params.get("i");

    if (!flightId) {
      infoPane.innerHTML = "<p class='text-red-500'>Missing flight ID in URL.</p>";
      throw new Error("Flight ID required");
    }

    console.log(flightId)
    let response;
    try {
      response = await fetch(`http://localhost:8080/public/flight?i=${flightId}`);
    } catch (err) {
      infoPane.innerHTML = "<p class='text-red-500'>Failed to fetch data.</p>";
      throw err;
    }

    const resJson = await response.json();
    if (!response.ok || !resJson?.data) {
      infoPane.innerHTML = "<p class='text-red-500'>Flight not found.</p>";
      throw new Error("Invalid response");
    }

    const flight = resJson.data;

    // --- Initialize map ---
    const centerLat = parseFloat(flight.origin?.lat || flight.path?.[0]?.lat || 0);
    const centerLng = parseFloat(flight.origin?.long || flight.path?.[0]?.long || 0);

    const map = new MercatorMap("gleomap", {
      center: [centerLat, centerLng],
      span:   5e6,
      maxSpan: 14e6
    });

    new MercatorTiles("https://tile.osm.org/{z}/{x}/{y}.png", {
      attribution: "<a href='http://osm.org/copyright'>© OSM contributors</a>"
    }).addTo(map);

    // --- Draw route ---
    const coords = flight.path
      .filter(p => !isNaN(parseFloat(p.lat)) && !isNaN(parseFloat(p.long)))
      .map(p => [parseFloat(p.lat), parseFloat(p.long)]);
    new Chain(coords, { colour: "#00ff00", width: 2 }).addTo(map);

    // --- Endpoints ---
    [
      [flight.origin.lat, flight.origin.long, flight.origin.icao, "red"],
      [flight.dest.lat, flight.dest.long, flight.dest.icao, "blue"]
    ].forEach(([lat, lng, code, color]) => {
      new Circle([parseFloat(lat), parseFloat(lng)], { size: 8, colour: color }).addTo(map);
      new TextLabel([parseFloat(lat), parseFloat(lng)], { text: code, offset: [10, 0] }).addTo(map);
    });



    // --- Info panel ---
    function formatDuration(secs) {
      const h = Math.floor(secs / 3600);
      const m = Math.round((secs % 3600) / 60);
      return `${h}h ${m}m`;
    }

    function renderInfoPane(f) {
      infoPane.innerHTML = `
        <h2 class="text-xl font-bold mb-4">Flight Details</h2>
        <div class="space-y-4">
          <div><h3 class="font-semibold">Aircraft</h3><p>${f.meta.aircraft} (${f.meta.livery})</p></div>
          <div><h3 class="font-semibold">Origin</h3><p>${f.origin.icao} – ${f.origin.name}</p></div>
          <div><h3 class="font-semibold">Destination</h3><p>${f.dest.icao} – ${f.dest.name}</p></div>
          <div><h3 class="font-semibold">Max Speed</h3><p>${f.meta.maxSpeed} kt</p></div>
          <div><h3 class="font-semibold">Violations</h3><p>${f.meta.violations}</p></div>
          <div><h3 class="font-semibold">Landings</h3><p>${f.meta.landings}</p></div>
          <div><h3 class="font-semibold">Duration</h3><p>${formatDuration(f.meta.durationSeconds)}</p></div>
          <div><h3 class="font-semibold">Started At</h3><p>${f.meta.startedAt.replace('T',' ').replace('Z',' UTC')}</p></div>
        </div>
      `;
    }

    renderInfoPane(flight);

    const ctrl = map.controls();
    ctrl.minOmniview = 0.5;
    ctrl.maxOmniview = 2.0;
  </script>
</body>
</html>
